/**
 * Browser Image Compression
 * v1.0.6
 * by Donald <donaldcwl@gmail.com>
 * https://github.com/Donaldcwl/browser-image-compression
 */

function _slicedToArray(t,e){return function _arrayWithHoles(t){if(Array.isArray(t))return t}(t)||function _iterableToArrayLimit(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,c=t[Symbol.iterator]();!(r=(o=c.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw a}}return n}(t,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var t="undefined"!=typeof window&&window.cordova&&window.cordova.require("cordova/modulemapper"),CustomFile=t&&t.getOriginalSymbol(window,"File")||File,CustomFileReader=t&&t.getOriginalSymbol(window,"FileReader")||FileReader;function drawFileInCanvas(t){return new Promise(function(e,n){var r,i,a=function $Try_1_Post(){try{return i=function drawImageInCanvas(t){var e=_slicedToArray(getNewCanvasAndCtx(t.width,t.height),2),n=e[0];return e[1].drawImage(t,0,0,n.width,n.height),n}(r),e([r,i])}catch(t){return n(t)}},o=function $Try_1_Catch(e){try{return function getDataUrlFromFile(t){return new Promise(function(e,n){var r=new CustomFileReader;r.onload=function(){return e(r.result)},r.onerror=function(t){return n(t)},r.readAsDataURL(t)})}(t).then(function(t){try{return function loadImage(t){return new Promise(function(e,n){var r=new Image;r.onload=function(){return e(r)},r.onerror=function(t){return n(t)},r.src=t})}(t).then(function(t){try{return r=t,a()}catch(t){return n(t)}},n)}catch(t){return n(t)}},n)}catch(t){return n(t)}};try{return createImageBitmap(t).then(function(t){try{return r=t,a()}catch(t){return o()}},o)}catch(t){o()}})}function canvasToFile(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;return new Promise(function(a,o){var c;return"function"==typeof OffscreenCanvas&&t instanceof OffscreenCanvas?t.convertToBlob({type:e,quality:i}).then(function(t){try{return(c=t).name=n,c.lastModified=r,$If_4.call(this)}catch(t){return o(t)}}.bind(this),o):function getFilefromDataUrl(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Date.now();return new Promise(function(r){for(var i=t.split(","),a=i[0].match(/:(.*?);/)[1],o=atob(i[1]),c=o.length,u=new Uint8Array(c);c--;)u[c]=o.charCodeAt(c);var s=new Blob([u],{type:a});s.name=e,s.lastModified=n,r(s)})}(t.toDataURL(e,i),n,r).then(function(t){try{return c=t,$If_4.call(this)}catch(t){return o(t)}}.bind(this),o);function $If_4(){return a(c)}})}function getExifOrientation(t){return new Promise(function(e,n){var r=new CustomFileReader;r.onload=function(t){var n=new DataView(t.target.result);if(65496!=n.getUint16(0,!1))return e(-2);for(var r=n.byteLength,i=2;i<r;){if(n.getUint16(i+2,!1)<=8)return e(-1);var a=n.getUint16(i,!1);if(i+=2,65505==a){if(1165519206!=n.getUint32(i+=2,!1))return e(-1);var o=18761==n.getUint16(i+=6,!1);i+=n.getUint32(i+4,o);var c=n.getUint16(i,o);i+=2;for(var u=0;u<c;u++)if(274==n.getUint16(i+12*u,o))return e(n.getUint16(i+12*u+8,o))}else{if(65280!=(65280&a))break;i+=n.getUint16(i,!1)}}return e(-1)},r.onerror=function(t){return n(t)},r.readAsArrayBuffer(t)})}function handleMaxWidthOrHeight(t,e){var n,r=t.width,i=t.height,a=e.maxWidthOrHeight,o=t;if(Number.isInteger(a)&&(r>a||i>a)){var c=_slicedToArray(getNewCanvasAndCtx(r,i),2);o=c[0],n=c[1],r>i?(o.width=a,o.height=i/r*a):(o.width=r/i*a,o.height=a),n.drawImage(t,0,0,o.width,o.height)}return o}function followExifOrientation(t,e){var n=t.width,r=t.height,i=_slicedToArray(getNewCanvasAndCtx(n,r),2),a=i[0],o=i[1];switch(4<e&&e<9?(a.width=r,a.height=n):(a.width=n,a.height=r),e){case 2:o.transform(-1,0,0,1,n,0);break;case 3:o.transform(-1,0,0,-1,n,r);break;case 4:o.transform(1,0,0,-1,0,r);break;case 5:o.transform(0,1,1,0,0,0);break;case 6:o.transform(0,1,-1,0,r,0);break;case 7:o.transform(0,-1,-1,0,r,n);break;case 8:o.transform(0,-1,1,0,0,n)}return o.drawImage(t,0,0,n,r),a}function getNewCanvasAndCtx(t,e){var n,r;try{r=(n=new OffscreenCanvas(t,e)).getContext("2d")}catch(t){r=(n=document.createElement("canvas")).getContext("2d")}return n.width=t,n.height=e,[n,r]}function compress(t,e){return new Promise(function(n,r){var i,a,o,c,u,s;return e.maxSizeMB=e.maxSizeMB||Number.POSITIVE_INFINITY,t instanceof Blob||t instanceof CustomFile?/^image/.test(t.type)?(i=e.maxIteration||10,a=1024*e.maxSizeMB*1024,drawFileInCanvas(t).then(function(f){try{var l=_slicedToArray(f,2);return l[0],o=handleMaxWidthOrHeight(o=l[1],e),new Promise(function(n,r){var i;if(!(i=e.exifOrientation))return getExifOrientation(t).then(function(t){try{return i=t,$If_3.call(this)}catch(t){return r(t)}}.bind(this),r);function $If_3(){return n(i)}return $If_3.call(this)}).then(function(f){try{return e.exifOrientation=f,o=followExifOrientation(o,e.exifOrientation),c=1,canvasToFile(o,t.type,t.name,t.lastModified,c).then(function(e){try{var f,l=function $Loop_4(){if(i--&&s.size>a){var e,n,u,f=_slicedToArray(getNewCanvasAndCtx(e=.9*o.width,n=.9*o.height),2);return u=f[0],f[1].drawImage(o,0,0,e,n),"image/jpeg"===t.type&&(c*=.9),canvasToFile(u,t.type,t.name,t.lastModified,c).then(function(t){try{return s=t,o=u,$Loop_4}catch(t){return r(t)}},r)}return[1]},h=function $Loop_4_exit(){try{s.name=t.name,s.lastModified=t.lastModified}catch(t){}return n(s)};return(u=e).size<=a?n(u):(s=u,(f=function(t){for(;t;){if(t.then)return void t.then(f,r);try{if(t.pop){if(t.length)return t.pop()?h.call(this):t;t=l}else t=t.call(this)}catch(t){return r(t)}}}.bind(this))(l))}catch(t){return r(t)}}.bind(this),r)}catch(t){return r(t)}}.bind(this),r)}catch(t){return r(t)}}.bind(this),r)):r(new Error("The file given is not an image")):r(new Error("The file given is not an instance of Blob or File"))})}var e,n=0;var r=function createWorker(t){return new Worker(URL.createObjectURL(new Blob(["(".concat(t,")()")])))}(function(){var t=!1;self.addEventListener("message",function(e){return new Promise(function(n,r){var i,a,o,c,u=e.data;i=u.file,a=u.id,o=u.imageCompressionLibUrl,c=u.options;var s=function $Try_1_Post(){try{return n()}catch(t){return r(t)}},f=function $Try_1_Catch(t){try{return self.postMessage({error:t.message+"\n"+t.stack,id:a}),s()}catch(t){return r(t)}};try{var l;return t||(importScripts(o),t=!0),compress(i,c).then(function(t){try{return l=t,self.postMessage({file:l,id:a}),s()}catch(t){return f(t)}},f)}catch(t){f(t)}})})});function compressOnWebWorker(t,i){return new Promise(function(a,o){return new Promise(function(c,u){e||(e=function createSourceObject(t){return URL.createObjectURL(new Blob([t],{type:"application/javascript"}))}("\n    canvasToFile = ".concat(canvasToFile,"\n    drawFileInCanvas = ").concat(drawFileInCanvas,"\n    followExifOrientation = ").concat(followExifOrientation,"\n    getExifOrientation = ").concat(getExifOrientation,"\n    getNewCanvasAndCtx = ").concat(getNewCanvasAndCtx,"\n    handleMaxWidthOrHeight = ").concat(handleMaxWidthOrHeight,"\n    \n    CustomFileReader = FileReader\n    \n    CustomFile = File\n    \n    function _slicedToArray(arr, n) { return arr }\n\n    function compress (){return (").concat(compress,").apply(null, arguments)}\n    ")));var s=n++;return r.addEventListener("message",function handler(t){t.data.id===s&&(r.removeEventListener("message",handler),t.data.error&&o(new Error(t.data.error)),a(t.data.file))}),r.postMessage({file:t,id:s,imageCompressionLibUrl:e,options:i}),c()})})}function imageCompression(t,e){return new Promise(function(n,r){if(e.useWebWorker="boolean"!=typeof e.useWebWorker||e.useWebWorker,e.useWebWorker&&"function"==typeof Worker){(function(){try{return $If_2.call(this)}catch(t){return r(t)}}).bind(this);var i=function $Try_1_Catch(i){try{return console.warn("Run compression in web worker failed:",i,", fall back to main thread"),n(compress(t,e))}catch(t){return r(t)}};try{return compressOnWebWorker(t,e).then(function(t){try{return n(t)}catch(t){return i(t)}},i)}catch(t){i(t)}}function $If_2(){return n(compress(t,e))}return $If_2.call(this)})}imageCompression.getExifOrientation=getExifOrientation;export default imageCompression;
//# sourceMappingURL=browser-image-compression.mjs.map
